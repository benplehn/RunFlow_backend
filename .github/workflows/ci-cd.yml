# .github/workflows/backend-ci-cd.yml
name: ğŸš€ Backend CI/CD Pipeline

on:
  push:
    branches: [development, staging]
  pull_request:
    branches: [development, staging]

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  # ========================================
  # ğŸ” VALIDATION PHASE
  # ========================================
  validate:
    name: ğŸ” Validate Code & Config
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”§ Validate supabase config
        run: |
          echo "ğŸ”§ Validating Supabase configuration..."
          if [ ! -f "supabase/config.toml" ]; then
            echo "âŒ config.toml not found!"
            exit 1
          fi
          echo "âœ… config.toml found"
          
          # Check PostgreSQL version
          if grep -q "major_version = 17" supabase/config.toml; then
            echo "âœ… PostgreSQL 17 configured"
          else
            echo "âš ï¸ PostgreSQL version check failed"
          fi

      - name: ğŸ” Lint SQL migrations
        run: |
          if [ -d "supabase/migrations" ] && [ "$(ls -A supabase/migrations 2>/dev/null)" ]; then
            echo "ğŸ” Validating SQL migrations syntax..."
            
            # Validation basique de syntaxe SQL sans connexion DB
            for migration_file in supabase/migrations/*.sql; do
              if [ -f "$migration_file" ]; then
                filename=$(basename "$migration_file")
                echo "ğŸ“„ Checking syntax: $filename"
                
                # VÃ©rifications basiques de syntaxe
                if grep -q "begin\|BEGIN" "$migration_file" && ! grep -q "commit\|COMMIT\|rollback\|ROLLBACK" "$migration_file"; then
                  echo "âš ï¸ Warning: $filename contains BEGIN but no COMMIT/ROLLBACK"
                fi
                
                # VÃ©rifier les mots-clÃ©s SQL essentiels
                if grep -qE "(CREATE|ALTER|DROP|INSERT|UPDATE|DELETE)" "$migration_file"; then
                  echo "âœ… Valid SQL statements found in $filename"
                else
                  echo "âš ï¸ Warning: No SQL statements detected in $filename"
                fi
              fi
            done
            
            echo "âœ… SQL syntax validation completed"
          else
            echo "â„¹ï¸ No migrations to validate"
          fi

      - name: ğŸ” Validate test files
        run: |
          if [ -d "supabase/tests" ] && [ "$(ls -A supabase/tests 2>/dev/null)" ]; then
            echo "ğŸ” Validating test files..."
            for test_file in supabase/tests/*.sql; do
              if [ -f "$test_file" ]; then
                echo "âœ… Found test: $(basename $test_file)"
                # Basic SQL syntax check
                if grep -q "begin;" "$test_file" && grep -q "rollback;" "$test_file"; then
                  echo "âœ… Test structure valid: $(basename $test_file)"
                else
                  echo "âš ï¸ Test might be missing transaction wrapper: $(basename $test_file)"
                fi
              fi
            done
          else
            echo "â„¹ï¸ No test files found"
          fi

  # ========================================
  # ğŸ§ª DATABASE TESTING PHASE
  # ========================================
  test:
    name: ğŸ§ª Database Tests
    runs-on: ubuntu-latest
    needs: [validate]
    
    services:
      postgres:
        image: supabase/postgres:17.4.1.064
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
          POSTGRES_USER: postgres
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”§ Initialize Supabase locally
        run: |
          echo "ğŸ”§ Setting up local Supabase environment..."
          supabase init --with-vscode-settings=false
          echo "âœ… Supabase initialized"

      - name: ğŸš€ Start Supabase services
        run: |
          echo "ğŸš€ Starting Supabase with external database..."
          supabase start --db-url postgresql://postgres:postgres@localhost:5432/postgres
          echo "âœ… Supabase services started"

      - name: ğŸ“Š Apply database migrations
        run: |
          echo "ğŸ“Š Applying database migrations..."
          supabase db reset --db-url postgresql://postgres:postgres@localhost:5432/postgres
          echo "âœ… All migrations applied successfully"

      - name: ğŸ§ª Run pgTAP tests
        run: |
          if [ -d "supabase/tests" ] && [ "$(ls -A supabase/tests/*.sql 2>/dev/null)" ]; then
            echo "ğŸ§ª Running pgTAP test suite..."
            
            test_count=0
            passed_count=0
            failed_count=0
            
            for test_file in supabase/tests/*.sql; do
              if [ -f "$test_file" ]; then
                test_name=$(basename "$test_file")
                echo "ğŸ”¬ Running test: $test_name"
                
                if supabase test db --db-url postgresql://postgres:postgres@localhost:5432/postgres "$test_file"; then
                  echo "âœ… PASSED: $test_name"
                  ((passed_count++))
                else
                  echo "âŒ FAILED: $test_name"
                  ((failed_count++))
                fi
                ((test_count++))
              fi
            done
            
            echo ""
            echo "ğŸ“Š TEST SUMMARY"
            echo "==============="
            echo "Total tests: $test_count"
            echo "Passed: $passed_count"
            echo "Failed: $failed_count"
            
            if [ $failed_count -gt 0 ]; then
              echo "âŒ Some tests failed - blocking deployment"
              exit 1
            else
              echo "âœ… All tests passed!"
            fi
          else
            echo "â„¹ï¸ No pgTAP tests found - skipping test phase"
          fi

      - name: ğŸ”§ Test Edge Functions (if any)
        run: |
          if [ -d "supabase/functions" ] && [ "$(ls -A supabase/functions 2>/dev/null)" ]; then
            echo "ğŸ”§ Testing Edge Functions..."
            
            # Start functions server in background
            timeout 30s supabase functions serve &
            FUNCTIONS_PID=$!
            sleep 10
            
            # Test function endpoints
            for func_dir in supabase/functions/*/; do
              if [ -d "$func_dir" ]; then
                func_name=$(basename "$func_dir")
                echo "ğŸ”¬ Testing function: $func_name"
                
                # Basic endpoint test (expect 401/400, not 404)
                status_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:54321/functions/v1/$func_name" || echo "000")
                
                if [ "$status_code" != "404" ]; then
                  echo "âœ… Function endpoint accessible: $func_name (status: $status_code)"
                else
                  echo "âŒ Function endpoint not found: $func_name"
                fi
              fi
            done
            
            # Clean up
            kill $FUNCTIONS_PID 2>/dev/null || true
            echo "âœ… Edge Functions test completed"
          else
            echo "â„¹ï¸ No Edge Functions found - skipping function tests"
          fi

  # ========================================
  # ğŸ¯ TYPE GENERATION PHASE
  # ========================================
  generate-types:
    name: ğŸ¯ Generate TypeScript Types
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”§ Setup local Supabase for types
        run: |
          supabase init --with-vscode-settings=false
          supabase start

      - name: ğŸ“Š Apply migrations for type generation
        run: |
          echo "ğŸ“Š Applying migrations for type generation..."
          supabase db reset
          echo "âœ… Database ready for type generation"

      - name: ğŸ¯ Generate TypeScript types
        run: |
          echo "ğŸ¯ Generating TypeScript types from database schema..."
          mkdir -p types
          supabase gen types typescript --local > types/database.types.ts
          
          # Validate generated types
          if [ -f "types/database.types.ts" ] && [ -s "types/database.types.ts" ]; then
            echo "âœ… Types generated successfully"
            echo "ğŸ“Š Generated file size: $(wc -c < types/database.types.ts) bytes"
            echo "ğŸ“Š Number of lines: $(wc -l < types/database.types.ts)"
            
            # Check for expected content
            if grep -q "export interface Database" types/database.types.ts; then
              echo "âœ… Database interface found in types"
            else
              echo "âš ï¸ Database interface not found - types might be incomplete"
            fi
          else
            echo "âŒ Type generation failed"
            exit 1
          fi

      - name: ğŸ’¾ Upload generated types
        uses: actions/upload-artifact@v4
        with:
          name: typescript-types-${{ github.sha }}
          path: types/database.types.ts
          retention-days: 7

  # ========================================
  # ğŸš€ DEPLOYMENT TO DEV
  # ========================================
  deploy-dev:
    name: ğŸš€ Deploy to Development
    runs-on: ubuntu-latest
    needs: [validate, test, generate-types]
    if: github.ref == 'refs/heads/development' && github.event_name == 'push'
    environment:
      name: development
      url: ${{ format('https://%s.supabase.co', env.SUPABASE_ACCESS_TOKEN) }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ” Login to Supabase
        run: |
          echo "ğŸ” Authenticating with Supabase..."
          supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          echo "âœ… Authentication successful"

      - name: ğŸ”— Link to Development project
        run: |
          echo "ğŸ”— Linking to development project..."
          supabase link --project-ref ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          echo "âœ… Successfully linked to development project"

      - name: ğŸ“Š Deploy database migrations
        run: |
          echo "ğŸ“Š Deploying database changes to DEVELOPMENT..."
          echo "â„¹ï¸ Including seed data for development testing"
          
          supabase db push --include-seed
          
          echo "âœ… Database deployment completed"

      - name: ğŸ”§ Deploy Edge Functions
        run: |
          if [ -d "supabase/functions" ] && [ "$(ls -A supabase/functions 2>/dev/null)" ]; then
            echo "ğŸ”§ Deploying Edge Functions to development..."
            
            for func_dir in supabase/functions/*/; do
              if [ -d "$func_dir" ]; then
                func_name=$(basename "$func_dir")
                echo "ğŸ“¤ Deploying function: $func_name"
              fi
            done
            
            supabase functions deploy
            echo "âœ… Edge Functions deployed successfully"
          else
            echo "â„¹ï¸ No Edge Functions to deploy"
          fi

      - name: ğŸ¯ Generate production types
        run: |
          echo "ğŸ¯ Generating types from deployed database..."
          mkdir -p types
          supabase gen types typescript --project-id ${{ secrets.SUPABASE_ACCESS_TOKEN }} > types/database.types.ts
          echo "âœ… Production types generated"

      - name: ğŸ“‹ Development deployment summary
        run: |
          echo ""
          echo "ğŸ‰ DEVELOPMENT DEPLOYMENT COMPLETED!"
          echo "====================================="
          echo "ğŸ”— Project URL: https://${{ secrets.SUPABASE_ACCESS_TOKEN }}.supabase.co"
          echo "ğŸ“Š Dashboard: https://supabase.com/dashboard/project/${{ secrets.SUPABASE_ACCESS_TOKEN }}"
          echo "ğŸ§ª Environment: Development (with seed data)"
          echo "â° Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ¯ Ready for testing your mobile app!"

  # ========================================
  # ğŸ­ DEPLOYMENT TO STAGING
  # ========================================
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate, test, generate-types]
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    environment:
      name: staging
      url: ${{ format('https://%s.supabase.co', env.SUPABASE_ACCESS_TOKEN) }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ” Login to Supabase
        run: |
          echo "ğŸ” Authenticating with Supabase..."
          supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          echo "âœ… Authentication successful"

      - name: ğŸ”— Link to Staging project
        run: |
          echo "ğŸ”— Linking to staging project..."
          supabase link --project-ref ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          echo "âœ… Successfully linked to staging project"

      - name: ğŸ“Š Deploy database migrations
        run: |
          echo "ğŸ“Š Deploying database changes to STAGING..."
          echo "âš ï¸ Deploying WITHOUT seed data (production-like environment)"
          
          supabase db push --include-seed=false
          
          echo "âœ… Database deployment completed"

      - name: ğŸ”§ Deploy Edge Functions
        run: |
          if [ -d "supabase/functions" ] && [ "$(ls -A supabase/functions 2>/dev/null)" ]; then
            echo "ğŸ”§ Deploying Edge Functions to staging..."
            supabase functions deploy
            echo "âœ… Edge Functions deployed successfully"
          else
            echo "â„¹ï¸ No Edge Functions to deploy"
          fi

      - name: ğŸ§ª Post-deployment validation
        run: |
          echo "ğŸ§ª Running post-deployment validation..."
          
          # Test database connection
          echo "ğŸ“¡ Testing database connection..."
          supabase db version --remote
          
          # Test API endpoints (basic connectivity)
          echo "ğŸ“¡ Testing API endpoints..."
          API_URL="https://${{ secrets.SUPABASE_ACCESS_TOKEN }}.supabase.co/rest/v1/"
          
          # Test health endpoint
          if curl -f "${API_URL}" -H "apikey: ${{ secrets.SUPABASE_ACCESS_TOKEN || 'dummy_key' }}" 2>/dev/null; then
            echo "âœ… API endpoint accessible"
          else
            echo "âš ï¸ API test completed (authentication required - expected)"
          fi
          
          echo "âœ… Post-deployment validation completed"

      - name: ğŸ¯ Generate production types
        run: |
          echo "ğŸ¯ Generating types from deployed database..."
          mkdir -p types
          supabase gen types typescript --project-id ${{ secrets.SUPABASE_ACCESS_TOKEN }} > types/database.types.ts
          echo "âœ… Production types generated"

      - name: ğŸ“‹ Staging deployment summary
        run: |
          echo ""
          echo "ğŸ‰ STAGING DEPLOYMENT COMPLETED!"
          echo "================================="
          echo "ğŸ”— Project URL: https://${{ secrets.SUPABASE_ACCESS_TOKEN }}.supabase.co"
          echo "ğŸ“Š Dashboard: https://supabase.com/dashboard/project/${{ secrets.SUPABASE_ACCESS_TOKEN }}"
          echo "ğŸ­ Environment: Staging (production-like, no seed data)"
          echo "â° Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âœ… Ready for final validation before production!"

  # ========================================
  # ğŸ“Š PIPELINE STATUS SUMMARY
  # ========================================
  status:
    name: ğŸ“Š Pipeline Status
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-staging]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate pipeline report
        run: |
          echo ""
          echo "ğŸ“Š BACKEND CI/CD PIPELINE REPORT"
          echo "================================="
          echo "â° Pipeline completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          
          # Development deployment status
          if [ "${{ needs.deploy-dev.result }}" == "success" ]; then
            echo "âœ… Development deployment: SUCCESS"
          elif [ "${{ needs.deploy-dev.result }}" == "skipped" ]; then
            echo "â­ï¸ Development deployment: SKIPPED (not dev branch)"
          else
            echo "âŒ Development deployment: FAILED"
          fi
          
          # Staging deployment status
          if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
            echo "âœ… Staging deployment: SUCCESS"
          elif [ "${{ needs.deploy-staging.result }}" == "skipped" ]; then
            echo "â­ï¸ Staging deployment: SKIPPED (not staging branch)"
          else
            echo "âŒ Staging deployment: FAILED"
          fi
          
          echo ""
          echo "ğŸ¯ Next steps:"
          
          if [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            echo "   â†’ Test your mobile app with the dev environment"
            echo "   â†’ When ready, merge to staging branch for final validation"
          elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            echo "   â†’ Perform final testing on staging environment"
            echo "   â†’ When validated, prepare for production deployment"
          fi
          
          echo ""
          echo "ğŸš€ Pipeline completed successfully!"